<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test-redaction.json</title>
    <style>
:root {
    --bg-primary: #1e1e1e;
    --bg-secondary: #252525;
    --bg-row-even: #181818;
    --bg-row-odd: #282828;
    --bg-hover: #303030;
    --bg-header-structure: #000000;
    --text-primary: #d4d4d4;
    --text-secondary: #9d9d9d;
    --border-color: #3e3e3e;
    --separator-line: #808080;
    --indent-marker: #808080;
    --name-color: #9cdcfe;
    --value-string: #ce9178;
    --value-number: #b5cea8;
    --value-boolean: #569cd6;
    --value-null: #808080;
    --object-indicator: #4ec9b0;
    --array-counter: #dcdcaa;
    --header-bg: #2d2d30;
    --button-bg: #0e639c;
    --button-hover: #1177bb;
}

body.light-mode {
    --bg-primary: #ffffff;
    --bg-secondary: #f5f5f5;
    --bg-row-even: #f5f5f5;
    --bg-row-odd: #e8e8e8;
    --bg-hover: #d8d8d8;
    --bg-header-structure: #ffffff;
    --text-primary: #1e1e1e;
    --text-secondary: #6a6a6a;
    --border-color: #d4d4d4;
    --separator-line: #808080;
    --indent-marker: #808080;
    --name-color: #0070c1;
    --value-string: #a31515;
    --value-number: #098658;
    --value-boolean: #0000ff;
    --value-null: #808080;
    --object-indicator: #267f99;
    --array-counter: #795e26;
    --header-bg: #f0f0f0;
    --button-bg: #007acc;
    --button-hover: #005a9e;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.4;
    padding: 0;
    margin: 0;
}

.container {
    width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
}

.header {
    background: var(--header-bg);
    padding: 12px 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 1000;
}

.title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.toolbar {
    display: flex;
    gap: 6px;
    align-items: center;
}

.toolbar-btn {
    background: var(--button-bg);
    border: none;
    color: white;
    padding: 6px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    min-height: 24px;
}

.toolbar-btn:hover {
    background: var(--button-hover);
}

.toolbar-btn:active {
    transform: scale(0.95);
}

.toolbar-btn svg.icon {
    display: block;
    width: 12px;
    height: 12px;
}

.toolbar-btn #themeIcon svg.icon {
    display: block;
}

.content {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.row {
    display: flex;
    align-items: flex-start;
    padding: 2px 8px;
    transition: background 0.15s;
    min-height: 22px;
}

.row:nth-child(even) {
    background: var(--bg-row-even);
}

.row:nth-child(odd) {
    background: var(--bg-row-odd);
}

.row:hover {
    background: var(--bg-hover) !important;
}

.row.clickable {
    cursor: pointer;
}

.array-header .name.clickable:hover {
    text-decoration: underline;
}

.indent {
    display: flex;
    align-items: stretch;
    flex-shrink: 0;
    gap: 0;
}

.indent-marker {
    width: 20px;
    height: 1.4em;
    border-left: 1px dashed var(--indent-marker);
    flex-shrink: 0;
}

.name {
    color: var(--name-color);
    font-weight: 500;
    min-width: 150px;
    padding-right: 16px;
    flex-shrink: 0;
    word-break: break-word;
}

.value {
    color: var(--text-primary);
    font-family: 'Consolas', 'Courier New', monospace;
    flex: 1;
    word-break: break-word;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.value-string {
    color: var(--value-string);
}

.value-number {
    color: var(--value-number);
}

.value-boolean {
    color: var(--value-boolean);
}

.value-null,
.value-undefined {
    color: var(--value-null);
    font-style: italic;
}

.object-indicator {
    color: var(--object-indicator);
    font-style: italic;
}

.empty {
    color: var(--text-secondary);
    font-style: italic;
}

.array-counter {
    color: var(--array-counter);
    font-weight: 600;
}

.array-counter .separator {
    margin: 0 4px;
    color: var(--text-secondary);
}

.object-container {
    margin: 2px 0;
    padding: 0;
    position: relative;
}

.object-children {
    /* Children are indented with markers, no container borders needed */
}

.array-container {
    margin: 2px 0;
    padding: 0;
    position: relative;
}

.array-element {
    margin: 0;
    position: relative;
    /* Array elements are indented with markers, no borders needed */
}

.object-header,
.array-header {
    font-weight: 600;
    background: transparent !important;
}

.header-content {
    flex: 1;
    display: flex;
    background: var(--bg-header-structure);
    border: 1px solid var(--separator-line);
    padding: 1px 8px;
    margin-left: -8px;
}

.header-content .name {
    min-width: 150px;
    padding-right: 16px;
}

.header-content .value {
    flex: 1;
}

/* Prevent double borders */
.array-container + .array-container,
.object-container + .array-container,
.array-container + .object-container,
.object-container + .object-container {
    margin-top: -1px;
}

@media (max-width: 768px) {
    .name {
        min-width: 100px;
        padding-right: 8px;
    }

    .header {
        padding: 8px 12px;
    }

    .content {
        padding: 5px;
    }
}

/* Context Menu */
.context-menu {
    position: fixed;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 4px 0;
    min-width: 150px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    z-index: 10000;
    display: none;
}

.context-menu.visible {
    display: block;
}

.context-menu-item {
    padding: 8px 16px;
    cursor: pointer;
    color: var(--text-primary);
    transition: background 0.15s;
}

.context-menu-item:hover {
    background: var(--bg-hover);
}

.context-menu-item.danger {
    color: #f48771;
}

/* Redacted rows */
.row.redacted,
.array-container.redacted,
.object-container.redacted {
    display: none !important;
}
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2 class="title">test-redaction.json</h2>
            <div class="toolbar">
                <button class="toolbar-btn" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
                    <span id="themeIcon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="12" height="12" class="icon">
  <path d="M 3 16 A 12.500632743066973 12.500632743066973 0 0 0 28 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 3 16 A 12.502070584163558 12.502070584163558 0 0 1 28 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 14 5 L 14 27" fill="none" stroke="currentColor" stroke-width="3.4" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 11 6 L 11 26" fill="none" stroke="currentColor" stroke-width="3.4" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 9 7 L 9 24" fill="none" stroke="currentColor" stroke-width="3.4" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 7 9 L 7 23" fill="none" stroke="currentColor" stroke-width="3.4" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 5 12 L 5 20" fill="none" stroke="currentColor" stroke-width="3.4" stroke-linecap="round" stroke-linejoin="round"/>
</svg></span>
                </button>
                <button class="toolbar-btn" onclick="exportToHtml()" title="Export to HTML File">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="12" height="12" class="icon">
  <path d="M 15 2 L 15 22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 15 22 L 22 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 16 23 L 8 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 26 15 L 29 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 29 15 L 29 28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 29 28 L 3 28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 3 28 L 3 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 3 15 L 6 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 9 15 L 15 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 23 15 L 21 17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 17 2 L 17 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 15 2 L 17 2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 8 16 L 9 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 16 23 L 24 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 23 15 L 24 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
                </button>
                <button class="toolbar-btn" id="browserBtn" onclick="viewInBrowser()" title="View in Browser">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="12" height="12" class="icon">
  <path d="M 4 9 L 27 9" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 4 21 L 27 21" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 3 15 A 12.500088185001491 12.500088185001491 0 0 0 28 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 3 15 A 12.502551020408163 12.502551020408163 0 0 1 28 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 28 15 L 28 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 15.25 3 Q 2.125 15 15.25 27" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 15 28 Q 28.625 15.0625 15.5 2.5625" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 15.5625 2.75 L 15 28" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 3 15 L 28 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
                </button>
                <button class="toolbar-btn" onclick="toggleCase()" title="Toggle Case (Pascal/camel)">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="12" height="12" class="icon">
  <path d="M 18 12 Q 25.125 8.4375 24.75 15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 25.6875 26 Q 24.125 21.3125 24.6875 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 23.75 17.6875 Q 17.4375 13.5 17.75 20.6875" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 24.8125 23.125 Q 18.1875 27.375 17.8125 21.125" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 23 13 L 24 13" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 16 26 L 10 5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 10 5 L 5 26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 7 20 L 14 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 2 30 L 30 30" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 30 30 L 30 2" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 30 2 L 2 2" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M 2 2 L 2 30" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
                </button>
                <button class="toolbar-btn" id="exportJsonBtn" onclick="exportRedactedJson()" title="Export Redacted JSON" style="display:none;">
                    <span style="font-size: 10px; font-weight: bold;">JSON</span>
                </button>
            </div>
        </div>
        <div class="content">
            <div class="object-container" data-path="user"><div class="object-header row level-1" data-level="1" data-path="user"><div class="indent"><span class="indent-marker"></span></div><div class="header-content"><div class="name">user</div><div class="value"><span class="object-indicator">{object}</span></div></div></div><div class="object-children"><div class="row level-2 clickable" data-level="2" data-path="user.name" onclick="nextInParentArray(this)"><div class="indent"><span class="indent-marker"></span><span class="indent-marker"></span></div><div class="name">name</div><div class="value"><span class="value value-string">John Doe</span></div></div><div class="row level-2 clickable" data-level="2" data-path="user.email" onclick="nextInParentArray(this)"><div class="indent"><span class="indent-marker"></span><span class="indent-marker"></span></div><div class="name">email</div><div class="value"><span class="value value-string">john@example.com</span></div></div></div></div><div class="object-container" data-path="settings"><div class="object-header row level-1" data-level="1" data-path="settings"><div class="indent"><span class="indent-marker"></span></div><div class="header-content"><div class="name">settings</div><div class="value"><span class="object-indicator">{object}</span></div></div></div><div class="object-children"><div class="row level-2 clickable" data-level="2" data-path="settings.theme" onclick="nextInParentArray(this)"><div class="indent"><span class="indent-marker"></span><span class="indent-marker"></span></div><div class="name">theme</div><div class="value"><span class="value value-string">dark</span></div></div><div class="row level-2 clickable" data-level="2" data-path="settings.notifications" onclick="nextInParentArray(this)"><div class="indent"><span class="indent-marker"></span><span class="indent-marker"></span></div><div class="name">notifications</div><div class="value"><span class="value value-boolean">true</span></div></div></div></div><div class="array-container" data-array-id="array_0drweuj6y" data-path="items"><div class="array-header row level-1" data-level="1" data-path="items"><div class="indent"><span class="indent-marker"></span></div><div class="header-content"><div class="name clickable" onclick="resetArray('array_0drweuj6y')" title="Click to reset to first element">items</div><div class="value"><span class="array-counter"><span class="current" id="array_0drweuj6y_current">1</span><span class="separator">/</span><span class="total">3</span></span></div></div></div><div class="array-element" data-array-id="array_0drweuj6y" data-index="0" style="display: block;"><div class="row level-2 clickable" data-level="2" data-path="items[0].id" onclick="nextInParentArray(this)"><div class="indent"><span class="indent-marker"></span><span class="indent-marker"></span></div><div class="name">id</div><div class="value"><span class="value value-number">1</span></div></div><div class="row level-2 clickable" data-level="2" data-path="items[0].value" onclick="nextInParentArray(this)"><div class="indent"><span class="indent-marker"></span><span class="indent-marker"></span></div><div class="name">value</div><div class="value"><span class="value value-string">first</span></div></div></div><div class="array-element" data-array-id="array_0drweuj6y" data-index="1" style="display: none;"><div class="row level-2 clickable" data-level="2" data-path="items[1].id" onclick="nextInParentArray(this)"><div class="indent"><span class="indent-marker"></span><span class="indent-marker"></span></div><div class="name">id</div><div class="value"><span class="value value-number">2</span></div></div><div class="row level-2 clickable" data-level="2" data-path="items[1].value" onclick="nextInParentArray(this)"><div class="indent"><span class="indent-marker"></span><span class="indent-marker"></span></div><div class="name">value</div><div class="value"><span class="value value-string">second</span></div></div></div><div class="array-element" data-array-id="array_0drweuj6y" data-index="2" style="display: none;"><div class="row level-2 clickable" data-level="2" data-path="items[2].id" onclick="nextInParentArray(this)"><div class="indent"><span class="indent-marker"></span><span class="indent-marker"></span></div><div class="name">id</div><div class="value"><span class="value value-number">3</span></div></div><div class="row level-2 clickable" data-level="2" data-path="items[2].value" onclick="nextInParentArray(this)"><div class="indent"><span class="indent-marker"></span><span class="indent-marker"></span></div><div class="name">value</div><div class="value"><span class="value value-string">third</span></div></div></div></div>
        </div>
    </div>
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item danger" onclick="redactSelectedRow()">Redact This Row</div>
    </div>
    <script>
console.log('=== JSON Viewer JavaScript Loaded ===');

// Global state
let caseMode = 'original'; // 'original', 'pascal', 'camel'
let vscodeApi = null;

// Initialize VSCode API (can only be called once)
(function initVSCodeApi() {
    if (typeof acquireVsCodeApi !== 'undefined') {
        vscodeApi = acquireVsCodeApi();
    }
})();

// Theme management
function toggleTheme() {
    const body = document.body;

    if (body.classList.contains('light-mode')) {
        body.classList.remove('light-mode');
        localStorage.setItem('theme', 'dark');
    } else {
        body.classList.add('light-mode');
        localStorage.setItem('theme', 'light');
    }
}

// Initialize theme from localStorage (only if not already set in body)
(function initTheme() {
    // Check if theme was already set when page was generated (from export/browser)
    const hasLightModeClass = document.body.classList.contains('light-mode');

    // For standalone files (browser/export), ignore localStorage and trust the body class
    // This ensures each file opens with its intended theme
    if (!vscodeApi) {
        // We're in standalone mode - set localStorage based on body class only
        if (hasLightModeClass) {
            localStorage.setItem('theme', 'light');
        } else {
            localStorage.setItem('theme', 'dark');
        }
    } else {
        // We're in VSCode, check localStorage for saved preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
        }
    }
})();

// Hide browser button if not in VSCode
(function hideBrowserBtnIfNotInVSCode() {
    if (!vscodeApi) {
        const browserBtn = document.getElementById('browserBtn');
        if (browserBtn) {
            browserBtn.style.display = 'none';
        }
    }
})();

// Export to HTML file
function exportToHtml() {
    try {
        // Check if we're in VSCode webview
        if (vscodeApi) {
            // Get current theme state
            const isLightMode = document.body.classList.contains('light-mode');

            // Get list of redacted element paths for server-side filtering
            const redactedPaths = getRedactedPaths();

            vscodeApi.postMessage({
                command: 'export',
                theme: isLightMode ? 'light' : 'dark',
                redactedPaths: redactedPaths
            });
        } else {
            // Standalone HTML - save the current page with proper theme
            // Clone the document to modify it without affecting the current page
            const docClone = document.documentElement.cloneNode(true);
            const bodyClone = docClone.querySelector('body');

            // Ensure the body has the correct theme class based on current state
            const isLightMode = document.body.classList.contains('light-mode');
            if (isLightMode) {
                bodyClone.classList.add('light-mode');
            } else {
                bodyClone.classList.remove('light-mode');
            }

            // Remove all redacted elements from the clone
            const redactedInClone = docClone.querySelectorAll('.redacted');
            redactedInClone.forEach(el => el.remove());

            const html = docClone.outerHTML;
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'json-export.html';
            a.click();
            URL.revokeObjectURL(url);
        }
    } catch (error) {
        console.error('Export failed:', error);
        alert('Export failed: ' + error.message);
    }
}

// View in browser
function viewInBrowser() {
    try {
        // Check if we're in VSCode webview
        if (vscodeApi) {
            // Get current theme state
            const isLightMode = document.body.classList.contains('light-mode');
            const theme = isLightMode ? 'light' : 'dark';

            // Get list of redacted element paths
            const redactedPaths = getRedactedPaths();

            console.log('Sending to browser with theme:', theme, 'redacted paths:', redactedPaths);
            vscodeApi.postMessage({
                command: 'viewInBrowser',
                theme: theme,
                redactedPaths: redactedPaths
            });
        } else {
            alert('Already viewing in browser!');
        }
    } catch (error) {
        console.error('View in browser failed:', error);
        alert('View in browser failed: ' + error.message);
    }
}

// Toggle case between Pascal, camel, and original
function toggleCase() {
    const nameElements = document.querySelectorAll('.name');

    // Store original values if not already stored
    nameElements.forEach(el => {
        if (!el.dataset.original) {
            el.dataset.original = el.textContent;
        }
    });

    // Cycle through modes
    if (caseMode === 'original') {
        caseMode = 'pascal';
    } else if (caseMode === 'pascal') {
        caseMode = 'camel';
    } else {
        caseMode = 'original';
    }

    // Apply the transformation
    nameElements.forEach(el => {
        const original = el.dataset.original;
        if (caseMode === 'pascal') {
            el.textContent = toPascalCase(original);
        } else if (caseMode === 'camel') {
            el.textContent = toCamelCase(original);
        } else {
            el.textContent = original;
        }
    });
}

function toPascalCase(str) {
    return str
        .replace(/[_-](.)/g, (_, c) => c.toUpperCase())
        .replace(/^(.)/, (_, c) => c.toUpperCase())
        .replace(/\s+(.)/g, (_, c) => c.toUpperCase());
}

function toCamelCase(str) {
    const pascal = toPascalCase(str);
    return pascal.charAt(0).toLowerCase() + pascal.slice(1);
}

// Redaction functionality
const redactedElements = new Set();
let contextMenuTarget = null;

function showContextMenu(event, element) {
    event.preventDefault();
    event.stopPropagation();

    const menu = document.getElementById('contextMenu');
    contextMenuTarget = element;

    // Position menu at mouse
    menu.style.left = event.pageX + 'px';
    menu.style.top = event.pageY + 'px';
    menu.classList.add('visible');
}

function hideContextMenu() {
    const menu = document.getElementById('contextMenu');
    menu.classList.remove('visible');
    contextMenuTarget = null;
}

function redactSelectedRow() {
    console.log('redactSelectedRow called, contextMenuTarget:', contextMenuTarget);
    if (!contextMenuTarget) return;

    // Find the element to redact - if this is an object/array header, redact the container instead
    let element = contextMenuTarget;
    console.log('Initial element classes:', element.className);

    // If this is an object-header or array-header row, find the parent container
    if (element.classList.contains('object-header') || element.classList.contains('array-header')) {
        const container = element.closest('.object-container, .array-container');
        console.log('Found container:', container ? container.className : 'none');
        if (container) {
            element = container;
        }
    }

    // Mark this element as redacted
    console.log('Redacting element:', element.className);
    element.classList.add('redacted');
    redactedElements.add(element);
    console.log('Total redacted elements:', redactedElements.size);

    // Find and redact all children
    redactChildren(element);

    // Show the export JSON button if there are redactions
    updateExportJsonButton();

    hideContextMenu();
}

function updateExportJsonButton() {
    const btn = document.getElementById('exportJsonBtn');
    if (btn) {
        if (redactedElements.size > 0) {
            btn.style.display = 'flex';
        } else {
            btn.style.display = 'none';
        }
    }
}

function redactChildren(element) {
    // For array containers, redact all array elements
    if (element.classList.contains('array-container')) {
        const arrayId = element.dataset.arrayId || element.querySelector('[data-array-id]')?.dataset.arrayId;
        if (arrayId) {
            const arrayElements = element.querySelectorAll(`[data-array-id="${arrayId}"][data-index]`);
            arrayElements.forEach(el => {
                el.classList.add('redacted');
                redactedElements.add(el);
                // Recursively redact children within array elements
                const childContainers = el.querySelectorAll('.array-container, .object-container, .row');
                childContainers.forEach(child => {
                    child.classList.add('redacted');
                    redactedElements.add(child);
                });
            });
        }
    }

    // For object containers, redact all children
    if (element.classList.contains('object-container')) {
        const children = element.querySelectorAll('.object-children > *');
        children.forEach(child => {
            child.classList.add('redacted');
            redactedElements.add(child);
            redactChildren(child);
        });
    }

    // For regular rows that might contain nested structures
    const childContainers = element.querySelectorAll('.array-container, .object-container');
    childContainers.forEach(child => {
        child.classList.add('redacted');
        redactedElements.add(child);
        redactChildren(child);
    });
}

function getRedactedData() {
    // Build JSON with redacted fields marked
    const content = document.querySelector('.content');
    return buildJsonFromDom(content);
}

function buildJsonFromDom(container) {
    // This will build a JSON object from the DOM, excluding redacted elements
    // For now, return a simple indication
    const allRows = container.querySelectorAll('.row:not(.redacted)');
    const result = {};

    allRows.forEach(row => {
        const nameEl = row.querySelector('.name');
        const valueEl = row.querySelector('.value');
        if (nameEl && valueEl && !row.closest('.redacted')) {
            const key = nameEl.textContent.trim();
            const value = valueEl.textContent.trim();
            result[key] = value;
        }
    });

    return result;
}

function getRedactedPaths() {
    // Get paths to redacted fields for server-side filtering
    const paths = [];

    redactedElements.forEach(element => {
        const path = getElementPath(element);
        console.log('Element path:', path, 'for element:', element.className);
        if (path && path.trim() !== '') {
            paths.push(path);
        } else {
            console.warn('Empty path for element:', element.className, element);
        }
    });

    console.log('Total redacted paths:', paths);
    return paths;
}

function exportRedactedJson() {
    try {
        if (vscodeApi) {
            // In VSCode, send message to export redacted JSON
            const redactedPaths = getRedactedPaths();
            console.log('Exporting JSON with redacted paths:', redactedPaths);
            vscodeApi.postMessage({
                command: 'exportJson',
                redactedPaths: redactedPaths
            });
        } else {
            // In standalone, use the client-side JSON builder
            const redactedData = buildRedactedJsonFromDom();
            const jsonStr = JSON.stringify(redactedData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'redacted-data.json';
            a.click();
            URL.revokeObjectURL(url);
        }
    } catch (error) {
        console.error('Export JSON failed:', error);
        alert('Export JSON failed: ' + error.message);
    }
}

function buildRedactedJsonFromDom() {
    // Build a proper JSON structure from visible (non-redacted) DOM elements
    const content = document.querySelector('.content');
    // For now, use the simpler version from buildJsonFromDom
    return buildJsonFromDom(content);
}

function getElementPath(element) {
    // Simply read the data-path attribute that was set during rendering
    const path = element.dataset.path || '';
    console.log('Getting path for element:', element.className, '-> path:', path);
    return path;
}

// Array navigation
const arrayStates = new Map();

function getArrayState(arrayId) {
    if (!arrayStates.has(arrayId)) {
        const elements = document.querySelectorAll(`[data-array-id="${arrayId}"][data-index]`);
        arrayStates.set(arrayId, {
            currentIndex: 0,
            totalCount: elements.length
        });
    }
    return arrayStates.get(arrayId);
}

function updateArrayDisplay(arrayId, newIndex) {
    const state = getArrayState(arrayId);
    const elements = document.querySelectorAll(`[data-array-id="${arrayId}"][data-index]`);

    // Hide all elements
    elements.forEach(el => {
        // Don't modify display for redacted elements - let CSS handle it
        if (!el.classList.contains('redacted') && !el.closest('.redacted')) {
            el.style.display = 'none';
        }
    });

    // Show the selected element (only if not redacted)
    if (elements[newIndex]) {
        if (!elements[newIndex].classList.contains('redacted') && !elements[newIndex].closest('.redacted')) {
            elements[newIndex].style.display = 'block';
        }
    }

    // Update counter
    state.currentIndex = newIndex;
    const counterEl = document.getElementById(`${arrayId}_current`);
    if (counterEl) {
        counterEl.textContent = (newIndex + 1).toString();
    }
}

function resetArray(arrayId) {
    updateArrayDisplay(arrayId, 0);
}

function nextInArray(arrayId) {
    const state = getArrayState(arrayId);
    const nextIndex = (state.currentIndex + 1) % state.totalCount;
    updateArrayDisplay(arrayId, nextIndex);
}

function nextInParentArray(element) {
    // Find the parent array container
    let current = element;
    while (current && !current.classList.contains('array-element')) {
        current = current.parentElement;
    }

    if (current && current.dataset.arrayId) {
        nextInArray(current.dataset.arrayId);
    }
}

// Prevent event bubbling for array headers
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - initializing redaction handlers');
    console.log('redactedElements Set exists:', typeof redactedElements !== 'undefined');

    document.querySelectorAll('.array-header').forEach(header => {
        header.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });

    // Add right-click handlers to all rows, array containers, and object containers
    const addContextMenuHandlers = () => {
        const elements = document.querySelectorAll('.row, .array-container, .object-container');
        console.log('Adding context menu handlers to', elements.length, 'elements');
        elements.forEach(element => {
            element.addEventListener('contextmenu', function(e) {
                showContextMenu(e, this);
            });
        });
    };

    addContextMenuHandlers();

    // Hide context menu when clicking elsewhere
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.context-menu')) {
            hideContextMenu();
        }
    });

    // Also hide on scroll
    document.querySelector('.content').addEventListener('scroll', hideContextMenu);
});
</script>
</body>
</html>